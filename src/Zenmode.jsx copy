import React, { useState, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Minimize2, Volume2, VolumeX } from 'lucide-react';

const FOCUS_AUDIO_URL = "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"; 

const Zenmode = ({ isActive, onClose }) => {
  const [phase, setPhase] = useState('intro'); // 'intro' | 'breathing' | 'countdown' | 'go'
  const [count, setCount] = useState(10);
  const [isMuted, setIsMuted] = useState(false);
  const audioRef = useRef(new Audio(FOCUS_AUDIO_URL));

  useEffect(() => {
    const audio = audioRef.current;
    if (isActive) {
      audio.loop = true;
      audio.volume = 0.2;
      audio.play().catch(() => {});
    } else {
      audio.pause();
      audio.currentTime = 0;
      setPhase('intro');
      setCount(10);
    }
    return () => audio.pause();
  }, [isActive]);

  // Fase Management
  useEffect(() => {
    if (!isActive) return;

    if (phase === 'intro') {
      setTimeout(() => setPhase('breathing'), 3000);
    } else if (phase === 'breathing') {
      // 8 seconden ademhalen (4 in, 4 uit)
      setTimeout(() => setPhase('countdown'), 8000);
    } else if (phase === 'countdown') {
      if (count > 0) {
        const timer = setInterval(() => setCount(prev => prev - 1), 2500); 
        return () => clearInterval(timer);
      } else {
        setPhase('go');
      }
    } else if (phase === 'go') {
      setTimeout(() => onClose(), 2500);
    }
  }, [isActive, phase, count, onClose]);

  return (
    <AnimatePresence>
      {isActive && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          transition={{ duration: 3 }}
          className="fixed inset-0 w-screen h-screen bg-black z-[9999] flex items-center justify-center overflow-hidden"
        >
          {/* VIGNETTE EFFECT (Behouden voor focus, maar golven zijn erachter zichtbaar) */}
          <div className="absolute inset-0 bg-[radial-gradient(circle,_transparent_10%,_rgba(0,0,0,0.95)_90%)] z-10 pointer-events-none" />

          {/* ACHTERGROND GOLVEN (Hersteld naar de mooie, brede, trage versie) */}
          <div className="absolute inset-0 flex items-center justify-center opacity-[0.15] pointer-events-none">
            {/* ViewBox aangepast naar 1000 500 voor een bredere, rustigere look */}
            <svg width="100%" height="100%" viewBox="0 0 1000 500" preserveAspectRatio="none">
              {[...Array(3)].map((_, i) => (
                <motion.path
                  key={i}
                  fill="none"
                  stroke="white"
                  strokeWidth="0.3"
                  animate={{ 
                    d: [
                      // Start: Rustige curve omhoog, gecentreerd rond Y=250
                      `M0,${250 + i * 10} Q250,${200 - i * 20} 500,${250 + i * 10} T1000,${250 + i * 10}`,
                      // Midden: Rustige curve omlaag
                      `M0,${250 + i * 10} Q250,${300 + i * 20} 500,${250 + i * 10} T1000,${250 + i * 10}`,
                      // Eind: Terug naar start voor een soepele loop
                      `M0,${250 + i * 10} Q250,${200 - i * 20} 500,${250 + i * 10} T1000,${250 + i * 10}`,
                    ]
                  }}
                  // Zeer trage animatieduur (35-65 seconden) voor ultieme rust
                  transition={{ duration: 35 + i * 15, repeat: Infinity, ease: "easeInOut" }}
                />
              ))}
            </svg>
          </div>

          {/* CONTENT LAYER */}
          <div className="relative z-20 text-center">
            <AnimatePresence mode="wait">
              
              {/* PHASE: INTRO */}
              {phase === 'intro' && (
                <motion.div key="intro" initial={{ opacity: 0 }} animate={{ opacity: 0.4 }} exit={{ opacity: 0, filter: 'blur(10px)' }} transition={{ duration: 2 }}>
                  <p className="text-white font-light text-xl tracking-[1em] uppercase">Laat alles los</p>
                </motion.div>
              )}

              {/* PHASE: BREATHING */}
              {phase === 'breathing' && (
                <motion.div key="breathing" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="flex flex-col items-center gap-12">
                  <motion.div 
                    animate={{ scale: [1, 1.5, 1], opacity: [0.2, 0.5, 0.2] }}
                    transition={{ duration: 4, repeat: 2, ease: "easeInOut" }}
                    className="w-32 h-32 rounded-full border border-white"
                  />
                  <motion.p 
                    animate={{ opacity: [0.3, 1, 0.3] }}
                    transition={{ duration: 4, repeat: 2 }}
                    className="text-white/50 text-[10px] uppercase font-black tracking-[0.5em]"
                  >
                    Adem in ... Adem uit
                  </motion.p>
                </motion.div>
              )}

              {/* PHASE: COUNTDOWN */}
              {phase === 'countdown' && (
                <motion.div key={count} initial={{ opacity: 0, filter: 'blur(5px)' }} animate={{ opacity: 0.25, filter: 'blur(0px)' }} exit={{ opacity: 0, filter: 'blur(5px)' }} transition={{ duration: 1.5 }}>
                  <span className="text-white font-black text-[8rem] md:text-[10rem] tabular-nums">{count}</span>
                </motion.div>
              )}

              {/* PHASE: GO */}
              {phase === 'go' && (
                <motion.div key="go" initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 0.8, scale: 1 }} className="text-emerald-400 font-black text-[6rem] italic tracking-widest">
                  NU.
                </motion.div>
              )}

            </AnimatePresence>
          </div>

          {/* CONTROLS */}
          <div className="absolute bottom-10 right-10 flex items-center gap-8 z-30 opacity-20 hover:opacity-100 transition-all duration-700">
             <button onClick={() => setIsMuted(!isMuted)} className="text-white">{isMuted ? <VolumeX size={18} /> : <Volume2 size={18} />}</button>
             <button onClick={onClose} className="text-white text-[8px] font-black uppercase tracking-[0.3em]">Overslaan</button>
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

export default Zenmode;